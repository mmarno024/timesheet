!function(e){"use strict";e.module("ngImgMap",[]).factory("ngImgMapCurArea",["$document",function(a){function r(e){e[0]>e[2]&&i(e,0,2),e[1]>e[3]&&i(e,1,3)}function i(e,a,r){var i=e[a];e[a]=e[r],e[r]=i}var t={area:void 0,mouse:[0,0],action:void 0};return a.find("body").on("mouseup",function(a){e.isDefined(t.area)&&(r(t.area.coords),delete t.area.isDraging,t.area=void 0)}),t}]).factory("ngImgMapCalculation",["$timeout",function(a){function r(e,a,r){return e>r?r:a>e?a:e}var i=function(e,a){this.dx=0,this.dy=0,this.imgw=e[0],this.imgh=e[1],this.img=[this.imgw,this.imgh],this.canw=Math.min(e[0],a[0]),this.ratio=e[0]&&this.canw?this.canw/e[0]:1};return i.prototype.init=function(e,a,r){var i=this;if(i._getOffset(a,r),0==i.dx&&0==i.dy)return!1;switch(i.curA=a,i.coords=i.curA.area.coords,i.curA.mouse=r,e[0]){case"move":i._move();break;case"resize":i._resize(e[1])}},i.prototype.getDragAction=function(a){var r=a.split(" "),i="move",t=[0,0,0,0];return e.forEach(r,function(a){switch(a){case"bar-remove":i=void 0;break;case"dragline":case"dragdot":i="resize";break;default:var r=new RegExp("ord-([nswe]+)").exec(a)||[];if(r.length){var o=r[1].split("");e.forEach(o,function(e){switch(e){case"w":t[0]=1;break;case"n":t[1]=1;break;case"e":t[2]=1;break;case"s":t[3]=1}})}}}),[i,t]},i.prototype.checkCoords=function(e){e[0]=+e[0]||0,e[1]=+e[1]||0,e[2]=+e[2]||0,e[3]=+e[3]||0;var a=this,i=0,t=0,o=e[0],n=e[1],s=e[2],d=e[3];if(0>o&&(i=-o,o=s=1),s>a.imgw&&(i=a.imgw-s,o=s=1),0>n&&(t=-n,n=d=1),d>a.imgh&&(t=a.imgh-d,n=d=1),(o||n)&&(e[0]+=o*i,e[1]+=n*t,e[2]+=s*i,e[3]+=d*t),Math.abs(e[0]-e[2])>a.imgw||Math.abs(e[1]-e[3])>a.imgh)for(var c=0,g=e.length;g>c;c++)e[c]=r(e[c],0,a.img[c%2]);return e},i.prototype._getOffset=function(e,a){var r=this;r.dx=parseInt((a[0]-e.mouse[0])/r.ratio),r.dy=parseInt((a[1]-e.mouse[1])/r.ratio)},i.prototype._move=function(){var e=this;e._checkEdge(e.coords,[e.coords[0]+e.dx,e.coords[1]+e.dy,e.coords[2]+e.dx,e.coords[3]+e.dy],[1,1,1,1])},i.prototype._resize=function(e){var a=this;a._checkEdge(a.coords,[a.coords[0]+a.dx*e[0],a.coords[1]+a.dy*e[1],a.coords[2]+a.dx*e[2],a.coords[3]+a.dy*e[3]],e)},i.prototype._checkEdge=function(e,a,r){for(var i=this,t=0,o=a.length;o>t;t++)if(a[t]>i.img[t%2]||a[t]<0){a[t]=e[t];var n=(t+2)%4;r[n]&&(a[n]=e[n])}i.curA.area.coords=a},i}]).controller("ngImgMapCtrl",["$scope","ngImgMapCalculation","ngImgMapCurArea",function(a,r,i){function t(){return o=a.ngImgMapFns,n=a.m=a.ngModel,e.isUndefined(n)?console.warn("ngImgMap need correct ngModel, please check data & format!"):(o&&e.isFunction(o.getImgSize)?s=o.getImgSize(n)||[1e3,100]:(s=[1e3,100],console.warn("ngImgMap need fn to get ImgSize, now use [1000, 100] !")),o&&e.isFunction(o.getCanSize)?d=o.getCanSize(n)||[1e3,100]:(d=[1e3,100],console.warn("ngImgMap need fn to get CanSize, now use [1000, 100] !")),c=new r(s,d),g=c.ratio,n.getCalculation=function(){return c},e.isDefined(n)&&e.forEach(n.maps,function(e){c.checkCoords(e.coords)}),void(a.wrapperStyle=function(){var e=c.img;return{width:e[0]*g+"px",height:e[1]*g+"px","background-image":"url("+n.pic_url+")"}}()))}var o,n,s,d,c,g,u=i,p=null;t(),a.$watch("m.pic_url",function(){c&&t()}),a.catchArea=function(a,r){a.preventDefault(),a.stopPropagation(),e.isDefined(r)&&r.coords&&(p=r,u.area=r,u.mouse=[a.pageX,a.pageY],u.action=c.getDragAction(a.target.className),["move","resize"].indexOf(u.action[0])>-1&&(u.area.isDraging=!0))},a.trackMouse=function(a){if(a.stopPropagation(),p==u.area){var r=u.action;e.isDefined(u.area)&&e.isDefined(r[0])&&u.area.coords&&c.init(r,u,[a.pageX,a.pageY])}},a.removeArea=function(a,r){e.isDefined(a[r])&&a.splice(r,1)},a.getAreaStyle=function(e){var a=e.coords||[10,10,50,50];return{width:parseInt(Math.abs(a[0]-a[2])*g)+"px",height:parseInt(Math.abs(a[1]-a[3])*g)+"px",left:parseInt(Math.min(a[0],a[2])*g)+"px",top:parseInt(Math.min(a[1],a[3])*g)+"px"}},a.getCurSize=function(e){var a=Math.abs(e[2]-e[0]),r=Math.abs(e[3]-e[1]);return[a,r].join(" * ")}}]).directive("ngImgMap",["$timeout",function(e){return{restrict:"EA",scope:{ngImgMapFns:"=ngImgMapFns",ngModel:"=ngModel"},templateUrl:"ngImgMap.html",controller:"ngImgMapCtrl"}}]).run(["$templateCache",function(e){var a='<div class="img-map-wrapper" ng-mousemove="trackMouse($event)" ng-style="wrapperStyle">    <div ng-repeat="area in m.maps" class="map-area" ng-mousedown="catchArea($event, area)" ng-class="{draging: area.isDraging}" ng-style="getAreaStyle(area)">        <div class="dragbar">            <div class="bar-title">{{$index+1}}</div>            <div class="bar-remove" ng-click="removeArea(m.maps, $index)">&times;</div>            <div class="bar-size">{{getCurSize(area.coords)}}</div>            <div class="bar-coords">{{area.coords}}</div>        </div>        <div class="ord-n dragline"></div>        <div class="ord-e dragline"></div>        <div class="ord-s dragline"></div>        <div class="ord-w dragline"></div>        <div class="ord-n dragdot"></div>        <div class="ord-e dragdot"></div>        <div class="ord-s dragdot"></div>        <div class="ord-w dragdot"></div>        <div class="ord-nw dragdot"></div>        <div class="ord-ne dragdot"></div>        <div class="ord-sw dragdot"></div>        <div class="ord-se dragdot"></div>    </div></div>';e.put("ngImgMap.html",a)}])}(angular);